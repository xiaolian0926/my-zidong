import com.alibaba.fastjson2.JSON;
import com.alibaba.fastjson2.JSONObject;
import com.alibaba.fastjson2.JSONPath;
import com.alibaba.fastjson2.JSONArray;
import me.hd.wauxv.plugin.api.callback.PluginCallBack.HttpCallback;
import java.text.SimpleDateFormat;
import java.util.Date;

// Wa_Weather_JP.java - Version 1.3 (2025-05-11, ä¼˜åŒ–è¾“å‡ºæ ¼å¼ï¼Œç§»é™¤é¢„æŠ¥)
String CAIYUN_TOKEN = "9sLrsS9ysdBTJeZo";
String GAODE_API_KEY = "5c35ebf2e98a082684b0970e04ab06ad";

// è‡ªå®šä¹‰æµ®ç‚¹æ•°æ ¼å¼åŒ–ï¼Œä¿ç•™ 1 ä½å°æ•°
String formatFloat(float value) {
    try {
        int rounded = Math.round(value * 10);
        int integerPart = rounded / 10;
        int decimalPart = Math.abs(rounded % 10);
        return integerPart + "." + decimalPart;
    } catch (Exception e) {
        log("æ ¼å¼åŒ–æµ®ç‚¹æ•°å¤±è´¥ï¼švalue=" + value + ", error=" + e.toString());
        return String.valueOf(value);
    }
}

// å¤„ç†æ¶ˆæ¯ï¼ˆæ”¯æŒä¸ªäººå’Œç¾¤èŠï¼‰
void onHandleMsg(Object msgInfo) {
    log("æ”¶åˆ°æ¶ˆæ¯: " + msgInfo.toString());
    long createTime = msgInfo.getCreateTime();
    long currentTime = System.currentTimeMillis();
    if (currentTime - createTime >= 60 * 1000) {
        log("æ¶ˆæ¯å·²è¿‡æœŸï¼ŒcreateTime=" + createTime + ", currentTime=" + currentTime);
        return;
    }

    if (msgInfo.isText()) {
        String content = msgInfo.getContent().trim();
        String talker = msgInfo.getTalker();
        boolean isRoomMsg = talker.endsWith("@chatroom");

        log("å¤„ç†æ¶ˆæ¯: content=" + content + ", talker=" + talker + ", isRoomMsg=" + isRoomMsg);

        if (isRoomMsg && talker.equals("48731101954@chatroom")) {
            log("å¿½ç•¥ç‰¹å®šç¾¤èŠæ¶ˆæ¯: talker=" + talker);
            return;
        }

        if (content.endsWith("å¤©æ°”")) {
            String city = content.substring(0, content.length() - 2).trim();
            if (city.isEmpty()) {
                sendText(talker, "è¯·è¾“å…¥æœ‰æ•ˆçš„åŸå¸‚åï¼Œä¾‹å¦‚ï¼šå¹¿å·å¤©æ°”");
                log("åŸå¸‚åä¸ºç©º: content=" + content);
                return;
            }
            log("å¼€å§‹è·å–å¤©æ°”: city=" + city);
            getCityWeather(talker, city);
        }
    }
}

// è·å–åŸå¸‚å¤©æ°”
void getCityWeather(String talker, String city) {
    String gaodeUrl = "https://restapi.amap.com/v3/geocode/geo?address=" + city + "&key=" + GAODE_API_KEY;
    log("é«˜å¾· API è¯·æ±‚: url=" + gaodeUrl);
    get(gaodeUrl, null, new HttpCallback() {
        public void onSuccess(int code, String content) {
            log("é«˜å¾· API å“åº”: code=" + code + ", content=" + content);
            try {
                JSONObject jsonObject = JSON.parseObject(content);
                String status = safeGetJsonPath(jsonObject, "$.status", "0");
                if (!"1".equals(status)) {
                    sendText(talker, "æ— æ³•æ‰¾åˆ°åŸå¸‚ï¼š" + city);
                    log("é«˜å¾· API å¤±è´¥ï¼šstatus=" + status + ", city=" + city);
                    return;
                }
                String location = safeGetJsonPath(jsonObject, "$.geocodes[0].location", "");
                if (location.isEmpty()) {
                    sendText(talker, "æ— æ³•è·å–åŸå¸‚ä½ç½®ï¼š" + city);
                    log("é«˜å¾· API ä½ç½®ä¸ºç©ºï¼šcity=" + city);
                    return;
                }
                String[] latLon = location.split(",");
                String longitude = latLon[0];
                String latitude = latLon[1];

                String caiyunUrl = "https://api.caiyunapp.com/v2.5/" + CAIYUN_TOKEN + "/" + longitude + "," + latitude + "/weather?alert=true&dailysteps=3&hourlysteps=6";
                log("å½©äº‘ API è¯·æ±‚: url=" + caiyunUrl);
                get(caiyunUrl, null, new HttpCallback() {
                    public void onSuccess(int code, String content) {
                        log("å½©äº‘ API å“åº”: code=" + code + ", content=" + content);
                        try {
                            JSONObject jsonObject = JSON.parseObject(content);
                            String status = safeGetJsonPath(jsonObject, "$.status", "");
                            if (!"ok".equals(status)) {
                                String errorMsg = safeGetJsonPath(jsonObject, "$.error", "æœªçŸ¥é”™è¯¯");
                                sendText(talker, "è·å–å¤©æ°”å¤±è´¥ï¼š" + errorMsg);
                                log("å½©äº‘ API å¤±è´¥ï¼šstatus=" + status + ", error=" + errorMsg);
                                return;
                            }

                            // æå–å®æ—¶å¤©æ°”æ•°æ®
                            String temperature = parseFloatJson(jsonObject, "$.result.realtime.temperature", "æœªçŸ¥");
                            String apparentTemp = parseFloatJson(jsonObject, "$.result.realtime.apparent_temperature", "æœªçŸ¥");
                            String skycon = safeGetJsonPath(jsonObject, "$.result.realtime.skycon", "æœªçŸ¥");
                            String humidity = parseHumidityJson(jsonObject, "$.result.realtime.humidity", "æœªçŸ¥");
                            String windSpeed = parseFloatJson(jsonObject, "$.result.realtime.wind.speed", "0");
                            String windDirection = parseWindDirection(jsonObject, "$.result.realtime.wind.direction", "æœªçŸ¥");
                            String windLevel = getWindLevel(Float.parseFloat(windSpeed.equals("æœªçŸ¥") ? "0" : windSpeed));
                            String visibility = parseFloatJson(jsonObject, "$.result.realtime.visibility", "æœªçŸ¥");
                            String pressure = parsePressureJson(jsonObject, "$.result.realtime.pressure", "æœªçŸ¥");
                            String aqi = safeGetJsonPath(jsonObject, "$.result.realtime.air_quality.aqi.chn", "æœªçŸ¥");
                            String uvIndex = parseIntJson(jsonObject, "$.result.realtime.life_index.ultraviolet.index", "æœªçŸ¥");
                            String weatherDesc = translateSkycon(skycon);
                            String emoji = getWeatherEmoji(skycon);
                            String uvDesc = getUvDescription(uvIndex);

                            // æ£€æŸ¥å…³é”®å­—æ®µ
                            if (temperature.equals("æœªçŸ¥") || skycon.equals("æœªçŸ¥") || humidity.equals("æœªçŸ¥")) {
                                sendText(talker, "è·å–å¤©æ°”å¤±è´¥ï¼šå®æ—¶æ•°æ®ç¼ºå¤±");
                                log("å®æ—¶æ•°æ®ç¼ºå¤±ï¼štemp=" + temperature + ", skycon=" + skycon + ", humidity=" + humidity);
                                return;
                            }

                            // æ—¥å‡ºæ—¥è½
                            String sunrise = parseTimeJson(jsonObject, "$.result.daily.astro[0].sunrise.time", "æœªçŸ¥");
                            String sunset = parseTimeJson(jsonObject, "$.result.daily.astro[0].sunset.time", "æœªçŸ¥");

                            // æ—¶é—´æ ¼å¼
                            SimpleDateFormat dateFormat = new SimpleDateFormat("MM-dd EEEE HH:mm");
                            String dateTime = dateFormat.format(new Date()).replace("æ˜ŸæœŸ", "å‘¨");

                            // æ„å»ºè¾“å‡º
                            StringBuilder response = new StringBuilder();
                            response.append("ğŸŒ¤ ").append(city).append("å¤©æ°”\n");
                            response.append("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n");
                            response.append("â° æ—¥æœŸâ”ƒ").append(dateTime).append("\n");
                            response.append("â˜ï¸ å¤©æ°”â”ƒ").append(weatherDesc).append(emoji).append("\n");
                            response.append("ğŸŒ¡ æ¸©åº¦â”ƒ").append(temperature).append("â„ƒ (ä½“æ„Ÿ ").append(apparentTemp).append("â„ƒ)\n");
                            response.append("ğŸ’§ æ¹¿åº¦â”ƒ").append(humidity).append("%\n");
                            response.append("ğŸ’¨ é£å‘â”ƒ").append(windDirection).append(" ").append(windLevel).append(" (").append(windSpeed).append("km/h)\n");
                            response.append("ğŸ¤ èƒ½è§åº¦â”ƒ").append(visibility).append("km\n");
                            response.append("ğŸ’› æ°”å‹â”ƒ").append(pressure).append("hPa\n");
                            response.append("ğŸ§¡ ç©ºæ°”è´¨é‡â”ƒ").append(getAqiDescription(aqi)).append(" (AQI ").append(aqi).append(")\n");
                            response.append("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n");

                            // æ—¥å†µ
                            response.append("ğŸ“… æ—¥å†µ\n");
                            response.append("ğŸŒ… æ—¥å‡ºâ”ƒ").append(sunrise).append("\n");
                            response.append("ğŸŒ‡ æ—¥è½â”ƒ").append(sunset).append("\n");
                            response.append("â˜€ï¸ ç´«å¤–çº¿â”ƒ").append(uvDesc).append("\n");
                            response.append("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n");

                            // ç”Ÿæ´»å»ºè®®
                            response.append("ğŸ’¡ ç”Ÿæ´»å»ºè®®\n");
                            response.append("ğŸ‘• ç©¿è¡£â”ƒæ¸©åº¦é€‚å®œï¼Œå»ºè®®ç©¿è–„å¤–å¥—\n");
                            response.append("ğŸ’§ æ¹¿åº¦â”ƒæ¹¿åº¦è¾ƒé«˜ï¼Œæ³¨æ„é€šé£\n");
                            response.append("ğŸŒ¬ï¸ ç©ºæ°”â”ƒç©ºæ°”è´¨é‡ä¼˜ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨\n");

                            sendText(talker, response.toString());
                            log("å¤©æ°”ä¿¡æ¯å‘é€æˆåŠŸ: city=" + city);
                        } catch (Exception e) {
                            sendText(talker, "è·å–å¤©æ°”å¤±è´¥ï¼šæ•°æ®è§£æé”™è¯¯");
                            log("å½©äº‘ API è§£æå¼‚å¸¸ï¼šerror=" + e.toString());
                        }
                    }

                    public void onError(Exception e) {
                        sendText(talker, "è·å–å¤©æ°”å¤±è´¥ï¼šè¯·ç¨åé‡è¯•");
                        log("å½©äº‘ API è¯·æ±‚å¼‚å¸¸ï¼šerror=" + (e != null ? e.toString() : "æœªçŸ¥å¼‚å¸¸"));
                    }
                });
            } catch (Exception e) {
                sendText(talker, "è·å–åŸå¸‚ä½ç½®å¤±è´¥ï¼šæ•°æ®è§£æé”™è¯¯");
                log("é«˜å¾· API è§£æå¼‚å¸¸ï¼šerror=" + e.toString());
            }
        }

        public void onError(Exception e) {
            sendText(talker, "è·å–åŸå¸‚ä½ç½®å¤±è´¥ï¼šè¯·ç¨åé‡è¯•");
            log("é«˜å¾· API è¯·æ±‚å¼‚å¸¸ï¼šerror=" + (e != null ? e.toString() : "æœªçŸ¥å¼‚å¸¸"));
        }
    });
}

// å®‰å…¨è·å– JSONPath å€¼
String safeGetJsonPath(JSONObject json, String path, String defaultValue) {
    try {
        Object result = JSONPath.eval(json, path);
        return result != null ? result.toString() : defaultValue;
    } catch (Exception e) {
        log("JSONPath è§£æå¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£ææµ®ç‚¹æ•° JSON å€¼
String parseFloatJson(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value != null) {
            return formatFloat(Float.parseFloat(value.toString()));
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£ææµ®ç‚¹æ•°å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£ææ¹¿åº¦ JSON å€¼
String parseHumidityJson(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value != null) {
            return String.valueOf(Math.round(Float.parseFloat(value.toString()) * 100));
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£ææ¹¿åº¦å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£ææ°”å‹ JSON å€¼
String parsePressureJson(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value != null) {
            return String.valueOf(Math.round(Float.parseFloat(value.toString()) / 100));
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£ææ°”å‹å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£ææ•´æ•° JSON å€¼
String parseIntJson(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value != null) {
            return String.valueOf(Math.round(Float.parseFloat(value.toString())));
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£ææ•´æ•°å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£ææ—¶é—´ JSON å€¼
String parseTimeJson(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value == null) {
            return defaultValue;
        }
        String timeStr = value.toString();
        if (timeStr.matches("\\d{2}:\\d{2}")) {
            return timeStr;
        } else if (timeStr.length() >= 16 && timeStr.contains("T")) {
            return timeStr.substring(11, 16); // æå– HH:mm
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£ææ—¶é—´å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è§£æé£å‘ JSON å€¼
String parseWindDirection(JSONObject json, String path, String defaultValue) {
    try {
        Object value = JSONPath.eval(json, path);
        if (value != null) {
            return getWindDirection(Float.parseFloat(value.toString()));
        }
        return defaultValue;
    } catch (Exception e) {
        log("è§£æé£å‘å¤±è´¥ï¼špath=" + path + ", error=" + e.toString());
        return defaultValue;
    }
}

// è½¬æ¢å½©äº‘å¤©æ°” skycon ä¸ºä¸­æ–‡æè¿°
String translateSkycon(String skycon) {
    if (skycon == null) return "æœªçŸ¥";
    switch (skycon) {
        case "CLEAR_DAY": return "æ™´å¤©";
        case "CLEAR_NIGHT": return "æ™´å¤œ";
        case "PARTLY_CLOUDY_DAY": return "å¤šäº‘";
        case "PARTLY_CLOUDY_NIGHT": return "å¤šäº‘";
        case "CLOUDY": return "é˜´å¤©";
        case "RAIN": return "é›¨";
        case "LIGHT_RAIN": return "å°é›¨";
        case "MODERATE_RAIN": return "ä¸­é›¨";
        case "HEAVY_RAIN": return "å¤§é›¨";
        case "STORM_RAIN": return "æš´é›¨";
        case "SNOW": return "é›ª";
        case "LIGHT_SNOW": return "å°é›ª";
        case "MODERATE_SNOW": return "ä¸­é›ª";
        case "HEAVY_SNOW": return "å¤§é›ª";
        case "WIND": return "å¤§é£";
        case "FOG": return "é›¾";
        case "HAZE": return "éœ¾";
        default: return skycon;
    }
}

// è·å–å¤©æ°”å¯¹åº”çš„ Emoji
String getWeatherEmoji(String skycon) {
    if (skycon == null) return "";
    switch (skycon) {
        case "CLEAR_DAY": return "â˜€ï¸";
        case "CLEAR_NIGHT": return "ğŸŒ™";
        case "PARTLY_CLOUDY_DAY": return "â›…";
        case "PARTLY_CLOUDY_NIGHT": return "ğŸŒ¥ï¸";
        case "CLOUDY": return "â˜ï¸";
        case "RAIN": return "ğŸŒ§ï¸";
        case "LIGHT_RAIN": return "ğŸŒ¦ï¸";
        case "MODERATE_RAIN": return "ğŸŒ§ï¸";
        case "HEAVY_RAIN": return "â›ˆï¸";
        case "STORM_RAIN": return "â›ˆï¸";
        case "SNOW": return "â„ï¸";
        case "LIGHT_SNOW": return "ğŸŒ¨ï¸";
        case "MODERATE_SNOW": return "ğŸŒ¨ï¸";
        case "HEAVY_SNOW": return "ğŸŒ¨ï¸";
        case "WIND": return "ğŸ’¨";
        case "FOG": return "ğŸŒ«ï¸";
        case "HAZE": return "ğŸŒ« éœ¾";
        default: return "";
    }
}

// è·å– AQI æè¿°
String getAqiDescription(String aqiStr) {
    try {
        int aqi = Integer.parseInt(aqiStr);
        if (aqi <= 50) return "ä¼˜";
        else if (aqi <= 100) return "è‰¯";
        else if (aqi <= 150) return "è½»åº¦æ±¡æŸ“";
        else if (aqi <= 200) return "ä¸­åº¦æ±¡æŸ“";
        else if (aqi <= 300) return "é‡åº¦æ±¡æŸ“";
        else return "ä¸¥é‡æ±¡æŸ“";
    } catch (Exception e) {
        return "æœªçŸ¥";
    }
}

// è·å–ç´«å¤–çº¿æè¿°
String getUvDescription(String uvIndexStr) {
    try {
        int uvIndex = Integer.parseInt(uvIndexStr);
        if (uvIndex <= 2) return "ä½ï¼Œæ— éœ€ç‰¹åˆ«é˜²æŠ¤";
        else if (uvIndex <= 5) return "ä¸­ç­‰ï¼Œå»ºè®®æ¶‚é˜²æ™’éœœ";
        else if (uvIndex <= 7) return "é«˜ï¼Œéœ€é˜²æ™’éœœå’Œå¸½å­";
        else if (uvIndex <= 10) return "å¾ˆå¼ºï¼Œé¿å…é•¿æ—¶é—´æš´æ™’";
        else return "æå¼ºï¼Œå°½é‡å‡å°‘æˆ·å¤–æ´»åŠ¨";
    } catch (Exception e) {
        return "æœªçŸ¥";
    }
}

// é£å‘è½¬æ¢
String getWindDirection(float direction) {
    if (direction >= 337.5 || direction < 22.5) return "åŒ—é£";
    else if (direction < 67.5) return "ä¸œåŒ—é£";
    else if (direction < 112.5) return "ä¸œé£";
    else if (direction < 157.5) return "ä¸œå—é£";
    else if (direction < 202.5) return "å—é£";
    else if (direction < 247.5) return "è¥¿å—é£";
    else if (direction < 292.5) return "è¥¿é£";
    else return "è¥¿åŒ—é£";
}

// é£åŠ›ç­‰çº§
String getWindLevel(float speed) {
    if (speed < 1.6) return "0çº§";
    else if (speed < 5.5) return "1çº§";
    else if (speed < 11.3) return "2çº§";
    else if (speed < 19.5) return "3çº§";
    else if (speed < 28.5) return "4çº§";
    else if (speed < 38.6) return "5çº§";
    else return "6çº§ä»¥ä¸Š";
}
